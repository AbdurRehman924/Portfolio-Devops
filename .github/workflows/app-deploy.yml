name: Application Build and Deploy

on:
  push:
    branches: [main]
    paths: ['app/**', 'docker/**', 'kubernetes/**']
  pull_request:
    branches: [main]
    paths: ['app/**', 'docker/**', 'kubernetes/**']
  workflow_dispatch:

env:
  REGISTRY: ${{ secrets.ACR_LOGIN_SERVER }}
  IMAGE_NAME: portfolio
  
jobs:
  test:
    name: Test Application
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: app/package-lock.json
    
    - name: Install dependencies
      run: npm ci
      working-directory: app
    
    - name: Run tests
      run: npm test -- --coverage --watchAll=false
      working-directory: app
    
    - name: Build application
      run: npm run build
      working-directory: app
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: build-files
        path: app/build/

  build-image:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to Azure Container Registry
      uses: azure/docker-login@v1
      with:
        login-server: ${{ secrets.ACR_LOGIN_SERVER }}
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: docker/Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Output image info
      run: |
        echo "## Docker Image Built" >> $GITHUB_STEP_SUMMARY
        echo "- Registry: ${{ env.REGISTRY }}" >> $GITHUB_STEP_SUMMARY
        echo "- Image: ${{ env.IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "- Tags: ${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY

  deploy:
    name: Deploy to AKS
    runs-on: ubuntu-latest
    needs: build-image
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'
    
    - name: Get AKS credentials
      run: |
        az aks get-credentials --resource-group ${{ secrets.RESOURCE_GROUP_NAME }} --name ${{ secrets.AKS_CLUSTER_NAME }}
    
    - name: Create ACR secret
      run: |
        kubectl create secret docker-registry acr-secret \
          --docker-server=${{ secrets.ACR_LOGIN_SERVER }} \
          --docker-username=${{ secrets.ACR_USERNAME }} \
          --docker-password=${{ secrets.ACR_PASSWORD }} \
          --dry-run=client -o yaml | kubectl apply -f -
    
    - name: Deploy to AKS
      run: |
        # Replace placeholders in Kubernetes manifests
        export ACR_LOGIN_SERVER=${{ secrets.ACR_LOGIN_SERVER }}
        export IMAGE_TAG=${{ github.sha }}
        
        envsubst < kubernetes/deployment.yaml | kubectl apply -f -
        kubectl apply -f kubernetes/namespace.yaml
    
    - name: Verify deployment
      run: |
        kubectl rollout status deployment/portfolio-app
        kubectl get services
        kubectl get pods
    
    - name: Output deployment info
      run: |
        echo "## Application Deployed" >> $GITHUB_STEP_SUMMARY
        echo "- Namespace: default" >> $GITHUB_STEP_SUMMARY
        echo "- Deployment: portfolio-app" >> $GITHUB_STEP_SUMMARY
        echo "- Image: ${{ secrets.ACR_LOGIN_SERVER }}/portfolio:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
